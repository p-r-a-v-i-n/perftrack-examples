name: Perf Regression Check

on: [push, pull_request]

jobs:
  perf:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Install perftrack
        run: |
          pip install git+https://github.com/p-r-a-v-i-n/perftrack.git@master

      - name: Run benchmark
        working-directory: demo-perf-app
        run: |
          perftrack run "python perf_scripts/bench_sum.py"

      - name: Set baseline if not exists
        working-directory: demo-perf-app
        run: |
          if [ ! -f .perftrack/baseline.json ]; then
            echo "No baseline found â€” creating baseline"
            perftrack baseline set-latest || true
          fi

      - name: Compare vs baseline
        working-directory: demo-perf-app
        run: |
          perftrack compare --fail-on-regression
